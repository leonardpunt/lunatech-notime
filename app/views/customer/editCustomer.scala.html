@(id: Long, customerForm: Form[Customer])

@import helper._

@customerManagerField(field: Field, className: String = "manager") = {
	@input(field, '_label -> "Customer manager", '_class -> className) { (id, name, value, _) =>
		<select id="@id" name="@name">
    		@User.options.map { v =>
        		<option value="@v._1" @(if(value == Some(v._1)) "selected" else "")>@v._2</option>
        	}
    	</select>
    	<a class="removeManager btn danger">Remove</a>
	}
}

@main("Customer") {

	<h1>Customer</h1>
	
	@if(flash.containsKey("error")) {
    	<div class="alert-message error">
            <strong>Oops!</strong> @flash.get("error")
        </div>
    } 
	
	@form(routes.Customers.update(id), 'id -> "form") {
		
		@inputText(customerForm("name"), '_label -> "Name")
		
		@inputText(customerForm("code"), '_label -> "Code")
		
		@textarea(customerForm("description"), args = '_text -> "Description", 'rows -> 3, 'cols -> 50)
		
		<div class="managers">
		
			@repeat(customerForm("customerManagers"), min = 0) { customerManager => 
				@customerManagerField(customerManager("id"))
            }
			
			@**
             * Keep an hidden block that will be used as template for Javascript copy code
             **@
			@customerManagerField(customerForm("customerManagers[x].id"), className = "manager_template")
             
	
			<div class="clearfix">
				<div class="input">
					<a class="addManager btn success">Add a customer manager</a>
				</div>
			</div>
	
			<input type="submit" value="Submit">
			<a href="@routes.Customers.all()">Cancel</a>
		</div>
	}
	
	
	<script type="text/javascript" charset="utf-8">
        
        $('.removeManager').live('click', function(e) {
            var manager = $(this).parents('.managers')
            $(this).parents('.manager').remove()
            renumber(manager)
        })
        
        $('.addManager').live('click', function(e) {
            var manager = $(this).parents('.managers')
            var template = $('.manager_template', manager)
            template.before('<div class="clearfix manager">' + template.html() + '</div>')
            renumber(manager)
        })
        
        $('#form').submit(function() {
            $('.manager_template').remove()
        })
        
        var renumber = function(manager) {
			$('.manager select', manager).each(function(i) {
				$(this).attr('name', $(this).attr('name').replace(/customerManagers\[.+\]/g, 'customerManagers[' + i + ']'))
			})
        }
        
    </script>
}